<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BMP SmartQuiz Online</title>

  <!-- Preconnect Ä‘á»ƒ giáº£m delay DNS/TLS -->
  <link rel="preconnect" href="https://gist.githubusercontent.com">
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://polyfill.io">

  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:24px;line-height:1.4;background:#fafafa}
    .box{max-width:860px;margin:0 auto;padding:16px 18px;border:1px solid #ddd;border-radius:12px;background:#fff}
    code{word-break:break-all}
    .bar{height:10px;background:#eee;border-radius:999px;overflow:hidden;margin-top:12px}
    .bar > div{height:100%;width:0%;background:#4a90e2;transition:width .25s}
    .small{margin-top:10px;color:#666;font-size:13px}
  </style>
</head>
<body>
  <div class="box">
    <h2>â³ Äang táº£i Ä‘á»...</h2>
    <div id="msg">Vui lÃ²ng chá» trong giÃ¢y lÃ¡t.</div>
    <div class="bar"><div id="bar"></div></div>
    <div class="small">
      Náº¿u Ä‘á»©ng mÃ£i, hÃ£y kiá»ƒm tra link cÃ³ dáº¡ng <code>?data=...</code> vÃ  <code>raw_url</code> cÃ²n truy cáº­p Ä‘Æ°á»£c.
    </div>
  </div>

<script>
(function(){
  const msgEl = document.getElementById('msg');
  const barEl = document.getElementById('bar');
  const msg = (t)=>{ try{ msgEl.innerHTML = t; }catch(e){} };
  const setBar = (p)=>{ try{ barEl.style.width = Math.max(0, Math.min(100, p)) + '%'; }catch(e){} };

  // Progress â€œgiáº£ láº­pâ€ Ä‘á»ƒ user Ä‘á»¡ tháº¥y treo (tÄƒng dáº§n tá»›i 85% rá»“i chá» fetch xong)
  let prog = 5;
  setBar(prog);
  const timer = setInterval(()=>{
    if (prog < 85) prog += Math.random()*6;
    setBar(prog);
  }, 300);

  function getParam(name){
    try{
      const u = new URL(window.location.href);
      return u.searchParams.get(name) || '';
    }catch(e){
      const m = new RegExp('[?&]'+name+'=([^&]+)').exec(location.search);
      return m ? decodeURIComponent(m[1]) : '';
    }
  }

  const data = getParam('data');
  if(!data){
    clearInterval(timer);
    setBar(0);
    msg('âŒ Thiáº¿u tham sá»‘ <code>data</code> trong URL.<br/>VÃ­ dá»¥: <code>?data=BASE64(raw_url)</code>');
    return;
  }

  let rawUrl = '';
  try{ rawUrl = atob(data); }
  catch(e){
    clearInterval(timer);
    setBar(0);
    msg('âŒ KhÃ´ng giáº£i mÃ£ Ä‘Æ°á»£c <code>data</code> (base64).');
    return;
  }

  rawUrl = (rawUrl||'').trim();
  if(!/^https?:\/\//i.test(rawUrl)){
    clearInterval(timer);
    setBar(0);
    msg('âŒ <code>raw_url</code> khÃ´ng há»£p lá»‡: <code>'+rawUrl+'</code>');
    return;
  }

  msg('ğŸ”— Äang táº£i ná»™i dung Ä‘á» tá»«:<br/><code>'+rawUrl+'</code>');

  // âœ… Tá»I Æ¯U: cho phÃ©p cache (Ä‘á»¡ táº£i láº¡i HTML lá»›n tá»« Gist)
  fetch(rawUrl, { cache: 'force-cache', credentials: 'omit' })
    .then(r=>{
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.text();
    })
    .then(html=>{
      clearInterval(timer);
      setBar(100);
      // Replace current document with fetched HTML (origin stays GitHub Pages)
      document.open();
      document.write(html);
      document.close();
    })
    .catch(err=>{
      clearInterval(timer);
      setBar(0);
      msg('âŒ Táº£i tháº¥t báº¡i: <b>'+String(err)+'</b><br/>HÃ£y má»Ÿ thá»­ raw_url trÃªn trÃ¬nh duyá»‡t Ä‘á»ƒ kiá»ƒm tra cÃ³ bá»‹ 404 hay bá»‹ private khÃ´ng.');
    });
})();
</script>
</body>
</html>
